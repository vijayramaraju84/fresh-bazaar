<!-- src/app/features/products/products.component.html -->
<div class="main-features" *ngIf="products.length > 0; else loading">

  <!-- FEATURED SLIDER – ONLY SHOW WHEN NO SEARCH -->
  <div class="slider-container" *ngIf="featuredProducts.length > 0 && !searchQuery">
    <button mat-icon-button class="nav-btn prev" (click)="prevSlide()" aria-label="Previous slide">
      <mat-icon>chevron_left</mat-icon>
    </button>

    <div class="slider">
      <div class="slide"
           *ngFor="let product of featuredProducts; let i = index"
           [@slideAnimation]="i === currentSlideIndex ? 'active' : 'inactive'"
           [class.active]="i === currentSlideIndex">
        <img [src]="product.image" [alt]="product.name" class="slide-image" />
        <div class="slide-content">
          <h3>{{ product.name }}</h3>
          <p *ngIf="product.offer" class="offer">{{ product.offer }}</p>
          <p>₹{{ product.price }}</p>
          <app-add-to-cart-button
            [product]="product"
            buttonText="Add to Cart"
            (added)="onItemAdded()"
            class="slider-add-btn">
          </app-add-to-cart-button>
        </div>
      </div>
    </div>

    <button mat-icon-button class="nav-btn next" (click)="nextSlide()" aria-label="Next slide">
      <mat-icon>chevron_right</mat-icon>
    </button>
  </div>

  <!-- CATEGORIES -->
  <div class="categories-section" *ngIf="categories.length > 0">
    <h2>Explore Categories</h2>
    <div class="categories-grid">
      <a *ngFor="let category of categories"
         [routerLink]="['/products']"
         [queryParams]="{ category: category }"
         class="category-card"
         @cardAnimation>
        <h3>{{ category }}</h3>
      </a>
    </div>
  </div>

  <!-- PRODUCTS GRID – AMAZON STYLE -->
  <div class="products-grid">
    <div *ngFor="let product of filteredProducts; trackBy: trackById"
         class="product-card"
         (click)="openDetail(product)"
         @cardAnimation>

      <!-- Image Container -->
      <div class="image-container">
        <img [src]="product.image"
             [alt]="product.name"
             class="product-image"
             loading="lazy" />

        <!-- Wishlist -->
        <button mat-icon-button
                class="wishlist-btn"
                [class.active]="product.wishlisted"
                (click)="toggleWishlist(product)"
                matTooltip="Add to wishlist"
                aria-label="Wishlist">
          <mat-icon>{{ product.wishlisted ? 'favorite' : 'favorite_border' }}</mat-icon>
        </button>

        <!-- Sold Out -->
        <div class="sold-out-overlay" *ngIf="product.stock === 0">
          <span>Sold Out</span>
        </div>
      </div>

      <!-- Content -->
      <div class="product-content">
        <h3 class="product-name" [matTooltip]="product.name">
          {{ product.name }}
        </h3>

        <!-- Rating -->
        <div class="rating" *ngIf="product.rating">
          <mat-icon *ngFor="let star of getStars(product.rating)" class="star">
            {{ star }}
          </mat-icon>
          <span class="rating-count">({{ product.reviews || 0 }})</span>
        </div>

        <!-- Price -->
        <div class="price-container">
  <span class="price">₹{{ product.price }}</span>
  <ng-container *ngIf="product.mrp != null && product.mrp > product.price">
    <span class="mrp">₹{{ product.mrp }}</span>
    <span class="discount">{{ getDiscountPercent(product) }}% off</span>
  </ng-container>
</div>

        <!-- Add to Cart -->
        <app-add-to-cart-button
          [product]="product"
          buttonText="Add to Cart"
          [disabled]="product.stock === 0"
          (added)="onItemAdded()"
          class="add-btn">
        </app-add-to-cart-button>

        <!-- Prime -->
        <div class="prime-badge" *ngIf="product.prime">
          <mat-icon>local_shipping</mat-icon>
          <span>Free Delivery</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SKELETON LOADING -->
<ng-template #loading>
  <div class="products-grid">
    <div *ngFor="let _ of [].constructor(8)" class="product-card skeleton">
      <div class="image-skeleton"></div>
      <div class="content-skeleton">
        <div class="line long"></div>
        <div class="line short"></div>
        <div class="line price"></div>
      </div>
    </div>
  </div>
</ng-template>

<!-- At the end of products.component.html -->
<app-product-detail
  *ngIf="selectedProduct"
  [product]="selectedProduct!"
  (close)="closeDetail()"
  (added)="onItemAdded()">
</app-product-detail>

<!-- TOAST -->
<app-toast></app-toast>