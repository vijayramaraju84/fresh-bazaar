<div class="products-page">

  <!-- HERO BANNER -->
  <div class="hero-banner" *ngIf="!searchQuery && featuredProducts.length">
    <div class="hero-slider">
      <div class="slide" *ngFor="let p of featuredProducts; let i = index"
           [class.active]="i === currentSlide" @slide>
        <img [src]="p.image" [alt]="p.name" class="hero-img" />
        <div class="hero-content">
          <h1>{{ p.name }}</h1>
          <p class="offer" *ngIf="p.offer">{{ p.offer }}</p>
          <p class="price">From ₹{{ p.price }}</p>
          <button mat-raised-button color="accent" (click)="openDetail(p, $event)">
            Shop Now
          </button>
        </div>
      </div>
      <button mat-icon-button class="nav prev" (click)="prev()" *ngIf="featuredProducts.length > 1">
        <mat-icon>chevron_left</mat-icon>
      </button>
      <button mat-icon-button class="nav next" (click)="next()" *ngIf="featuredProducts.length > 1">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div class="filter-bar" *ngIf="products.length">
    <div class="filters">
      <!-- Category -->
      <button mat-stroked-button [matMenuTriggerFor]="categoryMenu" class="filter-btn">
        <mat-icon>category</mat-icon>
        {{ selectedCategory || 'All Categories' }}
      </button>
      <mat-menu #categoryMenu="matMenu">
        <button mat-menu-item (click)="filterByCategory('')">All Categories</button>
        <button mat-menu-item *ngFor="let cat of categories" (click)="filterByCategory(cat)">
          {{ cat }}
        </button>
      </mat-menu>

      <!-- Sort Menu -->
      <button mat-stroked-button [matMenuTriggerFor]="sortMenu" class="filter-btn">
        <mat-icon>sort</mat-icon>
        {{ sortOptions[sortBy] }}
      </button>
      <mat-menu #sortMenu="matMenu">
        <button mat-menu-item 
                *ngFor="let opt of sortOptionKeys" 
                (click)="sortBy = opt; currentPage = 0; applyFilters()">
          {{ sortOptions[opt] }}
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- RESULTS COUNT -->
  <p class="results-count" *ngIf="filteredProducts.length">
    {{ filteredProducts.length }} products found
  </p>

  <!-- PRODUCTS GRID -->
  <div class="products-grid" #grid>
    <div *ngFor="let product of filteredProducts; trackBy: trackById"
         class="product-card" 
         (click)="openDetail(product, $event)"
         [@cardEnter]>

      <!-- Image + Badges -->
      <div class="img-wrapper">
        <img [src]="product.image" [alt]="product.name" loading="lazy" />
        
        <!-- Wishlist -->
        <button mat-icon-button class="wishlist" 
                [class.active]="product.wishlisted"
                (click)="toggleWishlist(product, $event)"
                matTooltip="Add to wishlist"
                aria-label="Wishlist">
          <mat-icon>{{ product.wishlisted ? 'favorite' : 'favorite_border' }}</mat-icon>
        </button>

        <!-- Prime -->
        <div class="prime-badges" *ngIf="product.prime">
          <span class="prime">Prime</span>
        </div>

        <!-- Sold Out -->
        <div class="sold-out" *ngIf="product.stock === 0">SOLD OUT</div>
      </div>

      <!-- Body -->
      <div class="card-body">
        <h3 class="title" [matTooltip]="product.name">{{ product.name }}</h3>

        <!-- Rating -->
        <div class="rating" *ngIf="product.rating">
          <span class="stars">
            <mat-icon *ngFor="let s of getStars(product.rating!)">{{ s }}</mat-icon>
          </span>
          <span class="count">({{ product.reviews ?? 0 }})</span>
        </div>

        <!-- Price -->
        <div class="price-row">
          <span class="current">₹{{ product.price }}</span>
          <span class="original" *ngIf="product.mrp && product.mrp > product.price">
            ₹{{ product.mrp }}
          </span>
          <span class="discount" *ngIf="product.mrp && product.mrp > product.price">
            {{ getDiscount(product) }}% off
          </span>
        </div>

        <!-- Add to Cart Button -->
        <div class="actions">
          <app-add-to-cart-button
            [product]="product"
            buttonText="Add"
            [disabled]="product.stock === 0"
            (click)="$event.stopPropagation()"
            (quantityChange)="onQuantityChange(product, $event)"
            class="add-btn">
          </app-add-to-cart-button>
      </div>
    </div>
  </div>

  <!-- LOAD MORE -->
  <div class="load-more" #loadMore>
    <mat-progress-spinner mode="indeterminate" diameter="40" *ngIf="loadingMore"></mat-progress-spinner>
    <p *ngIf="!hasMore && filteredProducts.length">No more products</p>
  </div>

  <!-- EMPTY STATE -->
  <div class="empty-state" *ngIf="!loading && filteredProducts.length === 0">
    <mat-icon>search_off</mat-icon>
    <h3>No products found</h3>
    <p>Try adjusting your filters or search term.</p>
    <button mat-raised-button color="accent" (click)="resetFilters()">Clear Filters</button>
  </div>

  <!-- SKELETON -->
  <div class="products-grid" *ngIf="loading">
    <div *ngFor="let _ of skeletonItems" class="product-card skeleton">
      <div class="img-skeleton"></div>
      <div class="body-skeleton">
        <div class="line long"></div>
        <div class="line short"></div>
        <div class="line price"></div>
      </div>
    </div>
  </div>
</div>

<!-- PRODUCT DETAIL MODAL -->
<app-product-detail
  *ngIf="selectedProduct"
  [product]="selectedProduct"
  (close)="closeDetail()"
  (added)="onAdd($event)">
</app-product-detail>